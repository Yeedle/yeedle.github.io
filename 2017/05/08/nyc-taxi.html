<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Seeing the Elephant | NYC&#39;s Taxi Flow</title>
    
    
    <link rel="preload" href="/assets/css/0.styles.98b0bdb2.css" as="style"><link rel="preload" href="/assets/js/app.98ca907b.js" as="script"><link rel="preload" href="/assets/js/2.100cc3b4.js" as="script"><link rel="prefetch" href="/assets/js/1.201fe279.js"><link rel="prefetch" href="/assets/js/3.02d9d9ad.js"><link rel="prefetch" href="/assets/js/4.5d396038.js"><link rel="prefetch" href="/assets/js/5.b0e6a4dc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.98b0bdb2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="router-link-active"><!----><span class="site-name">
      Seeing the Elephant
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/about.html" class="nav-link">about</a></div><div class="nav-item"><a href="https://github.com/yeedle" target="_blank" rel="noopener noreferrer" class="nav-link">github</a></div><!----></nav></div></header><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/about.html" class="nav-link">about</a></div><div class="nav-item"><a href="https://github.com/yeedle" target="_blank" rel="noopener noreferrer" class="nav-link">github</a></div><!----></nav><ul class="sidebar-links"><li><a href="/2016/09/11/hello-world.html" class="sidebar-link">Hello World</a></li><li><a href="/2017/05/08/nyc-taxi.html" class="active sidebar-link">NYC's Taxi Flow</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/" class="sidebar-link">Home</a></li></ul></div><div class="page"><div class="content"><h1>NYC's Taxi Flow</h1><h6 id="author-date">Published on: Monday, May 8, 2017</h6><div class="content custom"><p>This is an iteration of something I did last summer when I had the incredible experience of attending the <a href="https://ds3.research.microsoft.com/" target="_blank" rel="noopener noreferrer">Microsoft Reserch Data Science Summer School</a> (DS3). For my team’s <a href="https://www.microsoft.com/en-us/research/video/data-science-summer-school-2016-fare-share-flow-and-efficiency-in-nycs-taxi-system/" target="_blank" rel="noopener noreferrer">presentation</a>, we wanted to include a kind-of <a href="https://www.youtube.com/watch?v=jbkSRLYSojo" target="_blank" rel="noopener noreferrer">Hans Rosling moment</a>, where one of us gets to talk animatedly over an animated visualization of the flow of NYC’s taxi system, explaining the flow as the animation plays. The result of our efforts looked like this (<a href="https://github.com/msr-ds3/nyctaxi/blob/master/flow/flow_analysis.R" target="_blank" rel="noopener noreferrer">code here</a>):</p><p><img src="https://github.com/msr-ds3/nyctaxi/blob/master/figures/weekdays_cumsum_flow.gif?raw=true" alt="old gif"></p><p>It was kind of a last minute thing, and I’ve always wanted to go back and redo it. Since last summer, the tidyverse has made a lot of progress, specifically in the area of spatial data with the appearence of <code>sf</code>, a tidy package for spatial data manipulation, and I decided to redo it using <a href="https://github.com/edzer/sfr" target="_blank" rel="noopener noreferrer"><code>sf</code></a>, combined with <a href="https://github.com/thomasp85/tweenr" target="_blank" rel="noopener noreferrer"><code>tweenr</code></a>, a package I discovered earlier this year which lets you create smoother animations, and other tidy tools.</p><p>The data I used is freely available on the <a href="http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml" target="_blank" rel="noopener noreferrer">TLC’s website</a>. I chose to only work with the last 6 months of 2016, since the RAM on my laptop couldn’t handle more. Another cool thing that happened since last summer is that the TLC released a shapefile of the official taxi zones. So while the original animation relied on an “unofficial” source for NYC neighborhood boundaries, I now had the ability to use the TLC’s own shapefile.</p><h3 id="how-to"><a href="#how-to" aria-hidden="true" class="header-anchor">#</a> How To</h3><p>The first step is, of course, downloading the data. You can do this by pointing and clicking at the above link, or by writing a shell script. Personally, I like when everything happens inside R, so here’s how I did that (using the recently released <code>glue</code> package for string interpolation):</p><pre class="language-r"><code>library<span class="token punctuation">(</span>tidyverse<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>glue<span class="token punctuation">)</span>

data <span class="token operator">&lt;-</span> glue<span class="token punctuation">(</span><span class="token string">&quot;https://s3.amazonaws.com/nyc-tlc/trip+data/yellow_tripdata_{year}-{month}.csv&quot;</span><span class="token punctuation">,</span>
             year <span class="token operator">=</span> <span class="token string">&quot;2016&quot;</span><span class="token punctuation">,</span>
             month <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">&quot;07&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;08&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;09&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;11&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;12&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  map_df<span class="token punctuation">(</span>possibly<span class="token punctuation">(</span>read_csv<span class="token punctuation">,</span> otherwise <span class="token operator">=</span> data_frame<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  select<span class="token punctuation">(</span>pickup_datetime <span class="token operator">=</span> tpep_pickup_datetime<span class="token punctuation">,</span>
         dropoff_datetime <span class="token operator">=</span> tpep_dropoff_datetime<span class="token punctuation">,</span>
         passenger_count<span class="token punctuation">,</span>
         pickup_zone_id <span class="token operator">=</span> PULocationID<span class="token punctuation">,</span>
         dropoff_zone_id <span class="token operator">=</span> DOLocationID<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  drop_na<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p>Here’s what’s happening line-by-line: Using <code>glue</code>, I created a list of file URLs. I then <code>map</code>ped the list to <code>possibly(read_csv)</code> which does the heavy lifting of downloading the files, reading them into R as dataframes, and reducing everything to one big dataframe. Why only <code>possibly</code> you ask? The Internet is weird. Don’t leave the fate of your downloads in its hands. <code>possibly</code> gives you the option of specifying an <code>otherwise</code> option in case of failure. In our case, an empty data frame works fine in case of failure.</p><p>Since these files are quite big, this step takes a while. Since most of the dataframe is not needed and it’s just wasting the computer’s memory, I <code>select</code> the 5 columns needed for the animation, and drop all the rows with <code>NA</code> fields in them.</p><p>The next step is getting the shapefile with the neighborhood information. Again, you can do this by pointing and clicking on the TLC’s website. I prefer having R doing it for me:</p><pre class="language-r"><code>library<span class="token punctuation">(</span>curl<span class="token punctuation">)</span>

temp <span class="token operator">&lt;-</span> paste0<span class="token punctuation">(</span>tempdir<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;/taxi_zones.zip&quot;</span><span class="token punctuation">)</span>
curl_download<span class="token punctuation">(</span><span class="token string">&quot;https://s3.amazonaws.com/nyc-tlc/misc/taxi_zones.zip&quot;</span><span class="token punctuation">,</span>temp<span class="token punctuation">)</span>
taxi_shapefile_path <span class="token operator">&lt;-</span> paste0<span class="token punctuation">(</span>tempdir<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;/taxi_zones&quot;</span><span class="token punctuation">)</span>
unzip<span class="token punctuation">(</span>temp<span class="token punctuation">,</span> exdir <span class="token operator">=</span> taxi_shapefile_path<span class="token punctuation">)</span>
unlink<span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
</code></pre><p>That’s it. The shapefile are now downloaded and unzipped and sitting in the temporary directory.</p><pre class="language-r"><code>library<span class="token punctuation">(</span>sf<span class="token punctuation">)</span>
</code></pre><pre class="language-text"><code>## Linking to GEOS 3.5.0, GDAL 2.1.0, proj.4 4.9.2
</code></pre><pre class="language-r"><code>library<span class="token punctuation">(</span>magrittr<span class="token punctuation">)</span>

quietly<span class="token punctuation">(</span>st_read<span class="token punctuation">)</span><span class="token punctuation">(</span>taxi_shapefile_path<span class="token punctuation">,</span> <span class="token string">&quot;taxi_zones&quot;</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  extract2<span class="token punctuation">(</span><span class="token string">&quot;result&quot;</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  ggplot<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
  geom_sf<span class="token punctuation">(</span>aes<span class="token punctuation">(</span>fill <span class="token operator">=</span> borough<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  theme_minimal<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><img src="https://github.com/Yeedle/yeedle.github.io/blob/old/figure/source/2017-05-08-NYC-taxi-flow/read_shapefiles-1.png?raw=true" alt="plot_of_taxi_zones"></p><p>Cool! Unfortunately, as you might discern from the map, the taxi zones defined for some neighborhoods are a bit too granular for what I want. I used the <a href="https://github.com/dgrtwo/fuzzyjoin" target="_blank" rel="noopener noreferrer"><code>fuzzyjoin</code></a> package to combine the taxi zones into bigger neighborhoods, leaving the polygon dissolving to <code>sf</code>.</p><pre class="language-r"><code>library<span class="token punctuation">(</span>fuzzyjoin<span class="token punctuation">)</span>

neighborhoods <span class="token operator">&lt;-</span> data_frame<span class="token punctuation">(</span>
  zone <span class="token operator">=</span> c<span class="token punctuation">(</span>
    <span class="token string">&quot;Battery Park&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Clinton&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Crown Heights&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Chelsea&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Harlem&quot;</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;Financial District|World Trade Center&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Greenwich Village&quot;</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;Lenox Hill&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Lincoln Square&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Midtown&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Turtle Bay&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Williamsburg&quot;</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;Upper East Side&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Upper West Side&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;West Village&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;SoHo|Hudson Sq&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Washington Heights&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Yorkville&quot;</span>  
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

zones <span class="token operator">&lt;-</span> quietly<span class="token punctuation">(</span>st_read<span class="token punctuation">)</span><span class="token punctuation">(</span>taxi_shapefile_path<span class="token punctuation">,</span> <span class="token string">&quot;taxi_zones&quot;</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  extract2<span class="token punctuation">(</span><span class="token string">&quot;result&quot;</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  st_set_precision<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  regex_left_join<span class="token punctuation">(</span>neighborhoods<span class="token punctuation">,</span> by <span class="token operator">=</span> <span class="token string">&quot;zone&quot;</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  mutate<span class="token punctuation">(</span>zone <span class="token operator">=</span> if_else<span class="token punctuation">(</span><span class="token operator">!</span>is.na<span class="token punctuation">(</span>zone.y<span class="token punctuation">)</span><span class="token punctuation">,</span> zone.y<span class="token punctuation">,</span> as.character<span class="token punctuation">(</span>zone.x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  select<span class="token punctuation">(</span>LocationID<span class="token punctuation">,</span> zone<span class="token punctuation">,</span> borough<span class="token punctuation">,</span> geometry<span class="token punctuation">)</span>
</code></pre><p>This creates an <code>sf</code> object, which we’ll use for plotting NYC’s map. But for now, we don’t need the <code>sf</code> attributes, and since dataframe operations are faster, I ceated a dataframe with the same information as in <code>zones</code> minus the <code>geometry</code> list column.</p><pre class="language-r"><code>zone_df <span class="token operator">&lt;-</span> zones <span class="token percent-operator operator">%&gt;%</span> as_tibble<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> select<span class="token punctuation">(</span><span class="token operator">-</span>geometry<span class="token punctuation">)</span>
</code></pre><p>This is all we need to add the location names to the <code>data</code> dataframe:</p><pre class="language-r"><code>data <span class="token operator">&lt;-</span> data <span class="token percent-operator operator">%&gt;%</span> 
  left_join<span class="token punctuation">(</span>zone_df<span class="token punctuation">,</span> by <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">&quot;pickup_zone_id&quot;</span><span class="token operator">=</span><span class="token string">&quot;LocationID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  rename<span class="token punctuation">(</span>pickup_zone <span class="token operator">=</span> zone<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  left_join<span class="token punctuation">(</span>zone_df<span class="token punctuation">,</span> by <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">&quot;dropoff_zone_id&quot;</span><span class="token operator">=</span><span class="token string">&quot;LocationID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  rename<span class="token punctuation">(</span>dropoff_zone <span class="token operator">=</span> zone<span class="token punctuation">)</span>
</code></pre><p>Ok, with all the prelimenary data setup out of the way, it’s time to do the actual work. One way to capture the concept of the flow of people in a city, is to measure the difference of people who entered a given neighborhood and people who left it at a given time. This gives us a “flow score” for that particular neighborhood at that point in time. This is similar to how flow in a network is measured, and it’s a rough measure of how people move about the city using yellow cabs. This is particularly useful for visulizaiton purposes, where we can map a color palette to the range of ‘flow’ values over all the neighborhoods.</p><p>Since getting a moment-to-moment flow score is not very useful (because not much change happens at any given moment in most of NYC neighborhoods), it’s more useful to compute a neighborhood’s flow score at the beginiing of each hour of the day, and then interpolate the scores between the hour. In our data, which stretches over a 6 month period, we can calculate the score for every day at every hour, and then take the average.</p><p>There was only one problem with this approach. Some neighborhoods, at certain times in the day, have zero taxi cabs visiting them. To ensure that the average also takes into account the times when nothing happened, I created an empty dataframe, which I then joined with the original dataframe, to fill in the missing hours and days.</p><pre class="language-r"><code>library<span class="token punctuation">(</span>lubridate<span class="token punctuation">)</span>

empty_data <span class="token operator">&lt;-</span>  zone_df <span class="token percent-operator operator">%&gt;%</span>
  distinct<span class="token punctuation">(</span>zone<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  mutate<span class="token punctuation">(</span>month <span class="token operator">=</span> map<span class="token punctuation">(</span>zone<span class="token punctuation">,</span> <span class="token operator">~</span>tibble<span class="token punctuation">(</span>month <span class="token operator">=</span> rep<span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  unnest<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  mutate<span class="token punctuation">(</span>days_in_month <span class="token operator">=</span> days_in_month<span class="token punctuation">(</span>month<span class="token punctuation">)</span><span class="token punctuation">,</span>
         days_and_hours <span class="token operator">=</span> map<span class="token punctuation">(</span>days_in_month<span class="token punctuation">,</span>
                              <span class="token operator">~</span>tibble<span class="token punctuation">(</span>day_in_month <span class="token operator">=</span> rep<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>.x<span class="token punctuation">,</span> each <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      hour_of_day <span class="token operator">=</span> rep<span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">,</span> .x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  unnest<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  mutate<span class="token punctuation">(</span>date <span class="token operator">=</span> make_date<span class="token punctuation">(</span>year <span class="token operator">=</span> <span class="token number">2016</span><span class="token punctuation">,</span> month <span class="token operator">=</span> month<span class="token punctuation">,</span> day <span class="token operator">=</span> day_in_month<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  select<span class="token punctuation">(</span><span class="token operator">-</span>days_in_month<span class="token punctuation">,</span> <span class="token operator">-</span>day_in_month<span class="token punctuation">,</span> <span class="token operator">-</span>month<span class="token punctuation">)</span>

head<span class="token punctuation">(</span>empty_data<span class="token punctuation">)</span>
</code></pre><pre class="language-text"><code>## # A tibble: 6 × 3
##             zone hour_of_day       date
##              chr         int       date
## 1 Newark Airport           0 2016-07-01
## 2 Newark Airport           1 2016-07-01
## 3 Newark Airport           2 2016-07-01
## 4 Newark Airport           3 2016-07-01
## 5 Newark Airport           4 2016-07-01
## 6 Newark Airport           5 2016-07-01
</code></pre><p>With the <code>empty_data</code> dataframe ready, the flow scores can be calculated:</p><pre class="language-r"><code>data <span class="token operator">&lt;-</span> data <span class="token percent-operator operator">%&gt;%</span>
  mutate<span class="token punctuation">(</span>hour_of_day <span class="token operator">=</span> hour<span class="token punctuation">(</span>pickup_datetime<span class="token punctuation">)</span><span class="token punctuation">,</span>
         date <span class="token operator">=</span> as_date<span class="token punctuation">(</span>pickup_datetime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  gather<span class="token punctuation">(</span>type<span class="token punctuation">,</span> zone<span class="token punctuation">,</span> pickup_zone<span class="token punctuation">,</span> dropoff_zone<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  mutate<span class="token punctuation">(</span>count <span class="token operator">=</span> if_else<span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token string">&quot;pickup_zone&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span>passenger_count<span class="token punctuation">,</span> passenger_count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  group_by<span class="token punctuation">(</span>zone<span class="token punctuation">,</span> date<span class="token punctuation">,</span> hour_of_day<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  summarize<span class="token punctuation">(</span>total <span class="token operator">=</span> sum<span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  right_join<span class="token punctuation">(</span>empty_data<span class="token punctuation">,</span> by <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">&quot;zone&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;date&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hour_of_day&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  replace_na<span class="token punctuation">(</span>list<span class="token punctuation">(</span>total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  group_by<span class="token punctuation">(</span>zone<span class="token punctuation">,</span> hour_of_day<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  summarize<span class="token punctuation">(</span>log_avg <span class="token operator">=</span> log10<span class="token punctuation">(</span>abs<span class="token punctuation">(</span>mean<span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> sign<span class="token punctuation">(</span>mean<span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 

head<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre><pre class="language-text"><code>## # A tibble: 6 × 3
## # Groups: zone [1]
##                      zone hour_of_day   log_avg
##               &amp;lt;chr &amp;gt;      &amp;lt;int&amp;gt;     &amp;lt;dbl&amp;gt;
## 1 Allerton/Pelham Gardens           0 0.5317565
## 2 Allerton/Pelham Gardens           1 0.4072800
## 3 Allerton/Pelham Gardens           2 0.3815859
## 4 Allerton/Pelham Gardens           3 0.3010300
## 5 Allerton/Pelham Gardens           4 0.2602270
## 6 Allerton/Pelham Gardens           5 0.1365827
</code></pre><p>This now gives us a dataframe with 24 rows per neighborhood, a row for each hour in the day, and for each neighborhood, for each hour, the log average “flow score.” This is enoguh to make the animation at the top of this post. But for the redo, I wanted something more smooth. This is where <code>tweenr</code> comes in. <code>tweenr</code> is a wonderful package that allows to interpolate data for smoother animation.</p><pre class="language-r"><code>library<span class="token punctuation">(</span>tweenr<span class="token punctuation">)</span>

data_tweened <span class="token operator">&lt;-</span> data <span class="token percent-operator operator">%&gt;%</span> 
  bind_rows<span class="token punctuation">(</span>filter<span class="token punctuation">(</span>data<span class="token punctuation">,</span> hour_of_day <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> mutate<span class="token punctuation">(</span>hour_of_day <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  arrange<span class="token punctuation">(</span>zone<span class="token punctuation">,</span> hour_of_day<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  mutate<span class="token punctuation">(</span>ease <span class="token operator">=</span> <span class="token string">&quot;linear&quot;</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  tween_elements<span class="token punctuation">(</span><span class="token string">'hour_of_day'</span><span class="token punctuation">,</span><span class="token string">'zone'</span><span class="token punctuation">,</span><span class="token string">'ease'</span><span class="token punctuation">,</span> nframes <span class="token operator">=</span> <span class="token number">24</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  left_join<span class="token punctuation">(</span>zones <span class="token percent-operator operator">%&gt;%</span> group_by<span class="token punctuation">(</span>zone<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> summarise<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> by <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">&quot;.group&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;zone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
  mutate<span class="token punctuation">(</span>frame <span class="token operator">=</span> as_factor<span class="token punctuation">(</span>paste0<span class="token punctuation">(</span>ifelse<span class="token punctuation">(</span>as.integer<span class="token punctuation">(</span>hour_of_day<span class="token punctuation">)</span><span class="token percent-operator operator">%%</span><span class="token number">12</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'12'</span><span class="token punctuation">,</span> as.integer<span class="token punctuation">(</span>hour_of_day<span class="token punctuation">)</span><span class="token percent-operator operator">%%</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                        <span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span> 
                        ifelse<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>hour_of_day<span class="token operator">-</span>as.integer<span class="token punctuation">(</span>hour_of_day<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                        round<span class="token punctuation">(</span><span class="token punctuation">(</span>hour_of_day<span class="token operator">-</span>as.integer<span class="token punctuation">(</span>hour_of_day<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        ifelse<span class="token punctuation">(</span>as.integer<span class="token punctuation">(</span>hour_of_day<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">12</span> <span class="token operator">|</span> as.integer<span class="token punctuation">(</span>hour_of_day<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token string">&quot; AM&quot;</span><span class="token punctuation">,</span><span class="token string">&quot; PM&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><pre class="language-text"><code>## Warning: Column `.group`/`zone` joining factor and character vector,
## coercing into character vector
</code></pre><pre class="language-r"><code>head<span class="token punctuation">(</span>data_tweened<span class="token punctuation">)</span>
</code></pre><pre class="language-text"><code>##   hour_of_day   log_avg .frame                  .group
## 1           0 0.5317565      0 Allerton/Pelham Gardens
## 2           0 1.8532484      0           Alphabet City
## 3           0 0.1080942      0           Arden Heights
## 4           0 0.2166248      0 Arrochar/Fort Wadsworth
## 5           0 2.3311962      0                 Astoria
## 6           0 0.2362414      0            Astoria Park
##                         geometry    frame
## 1 POLYGON((1026308.75 256767.... 12:00 AM
## 2 POLYGON((992073.5 203714, 9... 12:00 AM
## 3 POLYGON((935843.25 144283.2... 12:00 AM
## 4 POLYGON((966568.75 158679.7... 12:00 AM
## 5 POLYGON((1010804.25 218919.... 12:00 AM
## 6 POLYGON((1005482.25 221686.... 12:00 AM
</code></pre><p>Here’s what happened in this chunk of code: in the first line I re-added hour 0 to the dataframe as hour 24 so that the animation is continously smoothed. Next the data is <code>arrange</code>d for each neighborhood in order of the hours. Then a column specifying the easing function to be used by <code>tweener</code> is added to the dataframe. I wanted a realistic look, so I went for “linear.” Then, <code>tween_elements</code> takes the dataframe, and interpolates the data as specified in the argumennts. I specified 240 frame, 10 for each hour, figuring that would give me a smooth enough animation yet not a too large file.</p><p>Once the data is tweened, it is handed off to <code>left_join</code> where it is rejoined with the <code>sf</code> object “<code>zone</code>” created earlier. Note that <code>zone</code> is grouped by zone and then summarize. This is to dissolve the multiple taxi zone polygons that compose one neighborhood, as specified in the neighborhood dataframe we <code>left_join</code>ed earlier. Finally, a new column called <code>frame</code> is added to the dataframe, in which the meaningless interpolated <code>hour_of_day</code> column is turned into meaninful time stamps. And now, showtime:</p><pre class="language-r"><code>library<span class="token punctuation">(</span>gganimate<span class="token punctuation">)</span>

plot <span class="token operator">&lt;-</span> ggplot<span class="token punctuation">(</span>data_tweened <span class="token punctuation">,</span> aes<span class="token punctuation">(</span>fill <span class="token operator">=</span> log_avg<span class="token punctuation">,</span> frame <span class="token operator">=</span> frame<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  geom_sf<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  scale_fill_distiller<span class="token punctuation">(</span>palette <span class="token operator">=</span> <span class="token string">&quot;RdBu&quot;</span><span class="token punctuation">,</span> na.value <span class="token operator">=</span> <span class="token string">&quot;#808080&quot;</span><span class="token punctuation">,</span> guide <span class="token operator">=</span> <span class="token string">&quot;legend&quot;</span><span class="token punctuation">,</span>
                       name <span class="token operator">=</span> <span class="token string">&quot;average # of people&quot;</span><span class="token punctuation">,</span>
                       breaks <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span>  <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       labels <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  theme_ipsum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>
  theme<span class="token punctuation">(</span>axis.text <span class="token operator">=</span> element_blank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        axis.ticks <span class="token operator">=</span> element_blank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        axis.title <span class="token operator">=</span> element_blank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        panel.background <span class="token operator">=</span> element_blank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  labs<span class="token punctuation">(</span>title <span class="token operator">=</span> <span class="token string">&quot;Time: &quot;</span><span class="token punctuation">,</span> caption <span class="token operator">=</span> <span class="token string">&quot;Average daily flow of people using the NYC Taxi system&quot;</span><span class="token punctuation">)</span>


gganimate<span class="token punctuation">(</span>plot<span class="token punctuation">,</span> ani.width <span class="token operator">=</span> <span class="token number">960</span><span class="token punctuation">,</span> ani.height <span class="token operator">=</span> <span class="token number">960</span><span class="token punctuation">,</span> interval <span class="token operator">=</span> <span class="token number">.05</span><span class="token punctuation">,</span> <span class="token string">&quot;taxi.gif&quot;</span><span class="token punctuation">)</span>
</code></pre><p><img src="https://github.com/yeedle/yeedle.github.io/blob/old/figure/source/2016-09-11-NYC-taxi-flow/taxi.gif?raw=true" alt="new animation"></p><p>Voilà!</p></div></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/2016/09/11/hello-world.html" class="prev">
          Hello World
        </a></span><span class="next"><a href="/" class="router-link-active">
          Home
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/2.100cc3b4.js" defer></script><script src="/assets/js/app.98ca907b.js" defer></script>
  </body>
</html>
